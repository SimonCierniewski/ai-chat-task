# Android App - AI Chat with SSE Streaming

Native Android application with Kotlin/Compose, featuring Supabase magic link authentication and real-time SSE streaming support.

## Features

- ğŸ” **Magic Link Authentication** via Supabase
- ğŸ”— **Deep Link Handling** for auth callbacks
- ğŸ’¾ **Persistent Session Storage** using DataStore
- ğŸŒŠ **SSE Streaming Support** for real-time chat responses
- ğŸ—ï¸ **Build Variants** for dev/prod environments
- ğŸ“± **Material 3 Design** with dynamic theming
- ğŸ”„ **Offline Support** with Room local cache (optional)

## Architecture

```
app/src/main/java/com/prototype/aichat/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ config/          # App configuration (AppConfig.kt)
â”‚   â””â”€â”€ util/            # Utility classes
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ api/             # API services (ChatApiService.kt)
â”‚   â”œâ”€â”€ auth/            # Authentication (SupabaseClient.kt)
â”‚   â”œâ”€â”€ local/           # Local storage (Room DAOs)
â”‚   â””â”€â”€ sse/             # SSE client (SSEClient.kt)
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ models/          # Domain models (Chat.kt)
â”‚   â””â”€â”€ repository/      # Repository interfaces
â”œâ”€â”€ ui/
â”‚   â”œâ”€â”€ components/      # Reusable UI components
â”‚   â”œâ”€â”€ navigation/      # Navigation graph (AppNavigation.kt)
â”‚   â”œâ”€â”€ screens/         # Screen composables
â”‚   â””â”€â”€ theme/           # Material 3 theming
â””â”€â”€ viewmodel/           # ViewModels for screens
```

## Setup

### Prerequisites

- Android Studio Hedgehog (2023.1.1) or later
- JDK 17 or later
- Android SDK 34
- Minimum device/emulator API 24 (Android 7.0)

### 1. Clone and Configure

```bash
cd apps/android
cp local.properties.example local.properties
```

### 2. Configure Environment Variables

Edit `local.properties` with your environment-specific values:

```properties
# SDK Location (auto-generated by Android Studio)
sdk.dir=/path/to/Android/Sdk

# Development Environment
dev.supabase.url=https://your-dev-project.supabase.co
dev.supabase.anonKey=your-dev-anon-key
dev.api.baseUrl=http://10.0.2.2:3000  # For emulator
dev.app.deeplink.scheme=aichat-dev
dev.app.deeplink.host=auth

# Production Environment
prod.supabase.url=https://your-prod-project.supabase.co
prod.supabase.anonKey=your-prod-anon-key
prod.api.baseUrl=https://api.your-domain.com
prod.app.deeplink.scheme=aichat
prod.app.deeplink.host=auth
```

**Important Notes:**
- Use `10.0.2.2` for Android emulator to access host machine's localhost
- Use your machine's IP address (e.g., `192.168.1.100`) for physical device testing
- Never commit `local.properties` to version control

### 3. Build Variants

The app supports multiple build variants combining build types and product flavors:

#### Build Types:
- **debug**: Development build with debugging enabled
- **release**: Production build with ProGuard/R8 minification

#### Product Flavors:
- **dev**: Development environment (local API, dev Supabase)
- **prod**: Production environment (production API, prod Supabase)

#### Available Variants:
- `devDebug` - Development environment with debugging
- `devRelease` - Development environment optimized
- `prodDebug` - Production environment with debugging
- `prodRelease` - Production environment optimized (for Play Store)

### 4. Building the App

#### Using Android Studio:

1. Open the project in Android Studio
2. Select build variant from Build Variants panel:
   - View â†’ Tool Windows â†’ Build Variants
   - Select desired variant (e.g., `devDebug`)
3. Run the app with Run â†’ Run 'app'

#### Using Command Line:

```bash
# Build all variants
./gradlew build

# Build specific variant
./gradlew assembleDevDebug      # Dev environment, debug build
./gradlew assembleDevRelease    # Dev environment, release build
./gradlew assembleProdDebug     # Prod environment, debug build
./gradlew assembleProdRelease   # Prod environment, release build

# Install on connected device/emulator
./gradlew installDevDebug

# Run tests
./gradlew testDevDebugUnitTest
./gradlew connectedDevDebugAndroidTest
```

Output APKs will be in:
- `app/build/outputs/apk/dev/debug/app-dev-debug.apk`
- `app/build/outputs/apk/prod/release/app-prod-release.apk`

### 5. Configure Supabase Deep Links

In your Supabase Dashboard:
1. Go to Authentication â†’ URL Configuration
2. Add Redirect URLs:
   - Dev: `aichat-dev://auth`
   - Prod: `aichat://auth`

### 6. Network Security Configuration

The app includes separate network security configs for dev and prod:

- **Dev**: Allows cleartext traffic to localhost/10.0.2.2 for local development
- **Prod**: HTTPS only, no cleartext traffic allowed

These are automatically applied based on the build variant.

## Key Dependencies

- **Compose BOM 2024.02.00**: Latest stable Compose libraries
- **Supabase Kotlin 2.1.0**: Authentication and database
- **OkHttp SSE 4.12.0**: Server-Sent Events for streaming
- **Kotlinx Serialization 1.6.2**: JSON serialization
- **Room 2.6.1**: Local database caching (optional)
- **Navigation Compose 2.7.7**: Screen navigation
- **DataStore 1.0.0**: Preferences storage

## Development Features

### SSE Streaming
The app includes a custom SSE client (`SSEClient.kt`) that handles:
- Real-time token streaming from the API
- Automatic reconnection with exponential backoff
- Error handling and timeout management

### Build Configuration
All environment-specific values are injected via `BuildConfig`:
- API endpoints
- Supabase configuration
- Deep link schemes
- Feature flags

### ProGuard Rules
The release builds include ProGuard rules to:
- Keep serialization classes
- Preserve Supabase/Ktor/OkHttp functionality
- Optimize Compose and coroutines

## Testing

```bash
# Unit tests
./gradlew test

# Instrumented tests (requires device/emulator)
./gradlew connectedAndroidTest

# Lint checks
./gradlew lint
```

## Troubleshooting

### Common Issues

1. **Cannot connect to API on emulator**
   - Ensure using `10.0.2.2` instead of `localhost`
   - Check API is running on port 3000

2. **Deep links not working**
   - Verify Supabase redirect URLs match your scheme
   - Check AndroidManifest intent filters

3. **Build fails with "SDK not found"**
   - Set correct `sdk.dir` in `local.properties`
   - Or let Android Studio generate it automatically

4. **SSE connection drops**
   - Check network security config for your environment
   - Verify API CORS settings allow your app origin

## Release Checklist

- [ ] Update version code and name in `build.gradle.kts`
- [ ] Ensure using `prodRelease` variant
- [ ] Test deep links with production URLs
- [ ] Verify ProGuard rules don't break functionality
- [ ] Generate signed APK/AAB for Play Store
- [ ] Test on multiple device configurations
- [ ] Update release notes

## Project Structure Summary

```
apps/android/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ build.gradle.kts        # App-level Gradle config with variants
â”‚   â”œâ”€â”€ proguard-rules.pro      # ProGuard/R8 rules
â”‚   â””â”€â”€ src/
â”‚       â””â”€â”€ main/
â”‚           â”œâ”€â”€ AndroidManifest.xml
â”‚           â”œâ”€â”€ java/.../aichat/
â”‚           â”‚   â”œâ”€â”€ core/       # Config, utilities
â”‚           â”‚   â”œâ”€â”€ data/       # API, SSE, auth, local storage
â”‚           â”‚   â”œâ”€â”€ domain/     # Models, repositories
â”‚           â”‚   â””â”€â”€ ui/         # Screens, components, navigation
â”‚           â””â”€â”€ res/
â”‚               â””â”€â”€ xml/
â”‚                   â”œâ”€â”€ network_security_config_dev.xml
â”‚                   â””â”€â”€ network_security_config_prod.xml
â”œâ”€â”€ build.gradle.kts             # Project-level Gradle
â”œâ”€â”€ settings.gradle.kts          # Gradle settings
â”œâ”€â”€ local.properties.example     # Environment template
â””â”€â”€ README.md                    # This file
```

## License

Proprietary - All rights reserved